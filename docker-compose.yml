version: "3.7"

################################################################################
# NETWORKING CONFIGURATION
################################################################################

networks:
    adjuftments:
        driver: bridge

################################################################################
# SERVICES CONFIGURATION
################################################################################

services:

    ####################################
    # POSTGRES DATABASE
    ####################################

    database:
        container_name: postgres
        image:          postgres:13.1
        environment:
            - POSTGRES_USER=${DATABASE_USER}
            - POSTGRES_PASSWORD=${DATABASE_PASSWORD}
            - POSTGRES_DB=${DATABASE_DB}
            - ALLOW_IP_RANGE="0.0.0.0/0"
        volumes:
            - ${DOCKER_DIRECTORY}/postgres/:/var/lib/postgresql/data
        logging:
            options:
                max-size: 10m
                max-file: "3"
        healthcheck:
            test: [ "CMD-SHELL", "pg_isready -U postgres" ]
            interval: 10s
            timeout:  5s
            retries:  5
        restart:        unless-stopped
        networks:
            adjuftments: null
        ports:
            - "5432:5432"

    ####################################
    # FLASK WEBSERVER
    ####################################

    webserver:
        container_name: webserver
        build:
            context:    ${DOCKER_DIRECTORY}/build/
            dockerfile: Dockerfile
        networks:
            adjuftments: null
        ports:
            - "5000:5000"
        volumes:
            - ${DOCKER_DIRECTORY}/:/home/adjuftments_v2/
        restart:        ${UNIVERSAL_RESTART_POLICY}
        depends_on:
            - database
        labels:
            traefik.enable: false
        environment:
            FLASK_APP:         "/home/adjuftments_v2/adjuftments_v2/views.py"
            FLASK_ENV:         "development"
            AIRTABLE_API_KEY:  ${AIRTABLE_API_KEY}
            DATABASE_USER:     ${DATABASE_USER}
            DATABASE_PASSWORD: ${DATABASE_PASSWORD}
            DATABASE_DB:       ${DATABASE_DB}
        working_dir:    /home/adjuftments_v2/adjuftments_v2
        command:        flask run --host=0.0.0.0

    ####################################
    # ADJUFTMENTS AIRTABLE EXECUTOR
    ####################################

    adjuftments:
        container_name: adjuftments
        build:
            context:    ${DOCKER_DIRECTORY}/build/
            dockerfile: Dockerfile
        networks:
            adjuftments: null
        volumes:
            - ${DOCKER_DIRECTORY}/:/home/adjuftments_v2/
            - ${DOCKER_DIRECTORY}/build/wait-for-postgres.sh:/tmp/wait-for-postgres.sh
        restart:        on-failure
        depends_on:
            - database
            - webserver
        labels:
            traefik.enable: false
        working_dir:    /home/adjuftments_v2/
        command:
            - /tmp/wait-for-postgres.sh
            - /home/adjuftments_v2/scripts/run_adjuftments.py
        environment:
            AIRTABLE_API_KEY:  ${AIRTABLE_API_KEY}
            FLASK_SETTINGS:    /home/adjuftments_v2/config/flask-sqlalchemy.py
            DATABASE_HOST:     ${DATABASE_HOST}
            DATABASE_USER:     ${DATABASE_USER}
            DATABASE_PASSWORD: ${DATABASE_PASSWORD}
            DATABASE_DB:       ${DATABASE_DB}